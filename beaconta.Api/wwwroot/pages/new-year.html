<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>إدارة السنوات الدراسية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 RTL + Icons (نفس المستخدم في الشاشات الأخرى) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">

    <!-- Select2 (لازم يكون عندك عاملاً في مشروعك) -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- خط (اختياري) -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Almarai', system-ui, sans-serif;
            background: #f6f8fb;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 18px 0 12px;
        }

        .page-title {
            font-weight: 800;
            font-size: 1.25rem;
        }

        .toolbar .btn {
            border-radius: 12px
        }

        .legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-inline-end: 6px;
            border: 1px solid #0001;
            vertical-align: middle
        }

        .year-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 700;
            font-size: .825rem;
            border: 1px solid #0002
        }

        .status-badge {
            font-size: .825rem
        }

        .select2-container .select2-selection--single {
            height: 38px
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px
        }

        .table-sm td, .table-sm th {
            padding: .55rem .75rem
        }
    </style>
</head>
<body>

    <main class="container-fluid px-3 px-md-4">
        <!-- Header -->
        <div class="page-header">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-calendar-week fs-3 text-primary"></i>
                <div>
                    <div class="page-title">إدارة السنوات الدراسية</div>
                    <div class="text-muted small">إنشاء/تعديل سنوات دراسية — دعم تعدد الفروع — تمييز لوني لكل سنة</div>
                </div>
            </div>
            <div class="toolbar d-flex flex-wrap gap-2">
                <button id="btnAdd" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> سنة جديدة
                </button>
                <button id="btnSetActive" class="btn btn-outline-primary">
                    <i class="bi bi-check2-circle me-1"></i> تعيين سنة فعّالة لفرع
                </button>
                <button id="btnExport" class="btn btn-outline-secondary">
                    <i class="bi bi-box-arrow-up me-1"></i> تصدير
                </button>
                <button id="btnRefresh" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-repeat me-1"></i> تحديث
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form id="filterForm" class="row g-3 align-items-end">
                    <div class="col-12 col-md-4">
                        <label class="form-label">الفرع</label>
                        <select id="filterBranchId" class="form-select select2" data-placeholder="كل الفروع">
                            <option value="">كل الفروع</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">الحالة</label>
                        <select id="filterStatus" class="form-select">
                            <option value="">الكل</option>
                            <option value="Open">مفتوح</option>
                            <option value="Closed">مغلق</option>
                            <option value="Archived">مؤرشف</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">نشطة الآن</label>
                        <select id="filterActive" class="form-select">
                            <option value="">الكل</option>
                            <option value="1">نشطة</option>
                            <option value="0">غير نشطة</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill"><i class="bi bi-funnel me-1"></i> تطبيق</button>
                        <button type="button" id="btnClearFilters" class="btn btn-light flex-fill">مسح</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-bold">السنوات</div>
                    <div class="text-muted small">
                        <span class="legend-dot" style="background:#2ecc70"></span> سنة حالية
                        <span class="ms-3 legend-dot" style="background:#f1c40f"></span> سنة مفتوحة
                        <span class="ms-3 legend-dot" style="background:#e74c3c"></span> سنة مغلقة/مؤرشفة
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="yearsTable" class="table table-sm table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>السنة</th>
                                <th>الاسم</th>
                                <th>الفرع</th>
                                <th>الفترة</th>
                                <th>الحالة</th>
                                <th>فعّالة</th>
                                <th>اللون</th>
                                <th>أوامر</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Upsert -->
    <div class="modal fade" id="yearModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <form id="yearForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i><span id="yearModalTitle">سنة جديدة</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" />
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label">رمز السنة (YearCode) <span class="text-danger">*</span></label>
                            <input name="yearCode" type="text" class="form-control" placeholder="مثال: 2025/2026" required>
                        </div>
                        <div class="col-12 col-md-5">
                            <label class="form-label">الاسم الظاهر <span class="text-danger">*</span></label>
                            <input name="name" type="text" class="form-control" placeholder="العام الدراسي 2025-2026" required>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">الفرع <span class="text-danger">*</span></label>
                            <select name="branchId" class="form-select select2" data-placeholder="اختر الفرع" required></select>
                        </div>

                        <div class="col-12 col-md-3">
                            <label class="form-label">تاريخ البداية <span class="text-danger">*</span></label>
                            <input name="startDate" type="date" class="form-control" required>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">تاريخ النهاية <span class="text-danger">*</span></label>
                            <input name="endDate" type="date" class="form-control" required>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">الحالة</label>
                            <select name="status" class="form-select">
                                <option value="Open">مفتوح</option>
                                <option value="Closed">مغلق</option>
                                <option value="Archived">مؤرشف</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label">اللون المميز</label>
                            <input name="colorHex" type="color" class="form-control form-control-color" value="#0d6efd" title="اختر لوناً للسنة">
                        </div>

                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActiveSwitch" name="isActive">
                                <label class="form-check-label" for="isActiveSwitch">تعيين كالسنة الفعّالة لهذا الفرع</label>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-warning d-none" id="overlapAlert">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                توجد سنوات أخرى تتقاطع مع فترة هذه السنة لنفس الفرع. الرجاء المراجعة.
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">ملاحظات</label>
                            <textarea name="notes" class="form-control" rows="2" placeholder="اختياري..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer gap-2">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save2 me-1"></i> حفظ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Set Active for Branch -->
    <div class="modal fade" id="activeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <form id="activeForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-check2-circle me-2"></i>تعيين سنة فعّالة لفرع</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">الفرع</label>
                            <select name="branchId" class="form-select select2" required></select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">السنة</label>
                            <select name="yearId" class="form-select" required></select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer gap-2">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check2 me-1"></i> تعيين
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ====== Core JS (ترتيب التحميل مهم) ====== -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

    <!-- ملفاتك المشتركة -->
    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/forms.js"></script>
    <script src="/js/datatable.js"></script>

    <!-- ملف الشاشة -->
    <script src="/js/years-create.page.js"></script>
</body>
</html>
