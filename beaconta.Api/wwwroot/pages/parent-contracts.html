<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>عقود أولياء الأمور</title>

    <!-- Bootstrap 5.3.3 RTL + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- DataTables 1.13.8 (+ Responsive + Buttons) -->
    <link href="https://cdn.datatables.net/v/bs5/dt-1.13.8/r-2.5.0/b-2.4.2/datatables.min.css" rel="stylesheet" />

    <!-- Select2 4.1.0-rc.0 + select2-bootstrap-5-theme -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.min.css" rel="stylesheet" />

    <link href="/css/parent-contracts.css" rel="stylesheet" />
</head>
<body class="bg-light">

    <div class="container-fluid py-3">

        <!-- Header + Actions (role-aware) -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center gap-2">
                <h1 class="h4 m-0"><i class="bi bi-file-text me-2"></i> عقود أولياء الأمور</h1>
                <span id="roleBadge" class="badge rounded-pill text-bg-secondary">—</span>
            </div>
            <div class="btn-group" id="managerActions">
                <button id="btnNewFull" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> عقد كامل</button>
                <button id="btnExportCsv" class="btn btn-outline-secondary"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
                <button id="btnExportJson" class="btn btn-outline-secondary"><i class="bi bi-filetype-json me-1"></i> JSON</button>
                <button id="btnPrint" class="btn btn-outline-dark"><i class="bi bi-printer me-1"></i> طباعة</button>
                <button id="btnResetDemo" class="btn btn-outline-danger"><i class="bi bi-arrow-counterclockwise me-1"></i> إعادة بيانات التجربة</button>
            </div>
        </div>

        <!-- Filters (manager only) -->
        <div class="card mb-3" id="managerFilters">
            <div class="card-body row g-2">
                <div class="col-12 col-sm-6 col-xl-3">
                    <label class="form-label">الفرع</label>
                    <select id="selBranch" class="form-select select2" data-placeholder="اختر الفرع"></select>
                </div>
                <div class="col-12 col-sm-6 col-xl-3">
                    <label class="form-label">السنة</label>
                    <select id="selYear" class="form-select select2" data-placeholder="اختر السنة"></select>
                </div>
                <div class="col-12 col-sm-6 col-xl-3">
                    <label class="form-label">الحالة</label>
                    <select id="selStatus" class="form-select select2">
                        <option value="">الكل</option>
                        <option value="Draft">مسودة</option>
                        <option value="Active">ساري</option>
                        <option value="Closed">مغلق</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-xl-3 d-flex align-items-end">
                    <button id="btnReload" class="btn btn-outline-primary w-100"><i class="bi bi-arrow-repeat me-1"></i> تحديث</button>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mb-3">
            <div class="col-6 col-lg-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="kpi-title">عدد العقود</div>
                        <div class="kpi-value" id="kpiCount">0</div>
                        <div class="kpi-sub" id="kpiCountSub">—</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="kpi-title">إجمالي العقود</div>
                        <div class="kpi-value" id="kpiTotal">0.00</div>
                        <div class="kpi-sub">قبل الخصم</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="kpi-title">المدفوع</div>
                        <div class="kpi-value text-success" id="kpiPaid">0.00</div>
                        <div class="kpi-sub">دفعات محصلة</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="kpi-title">المتبقي</div>
                        <div class="kpi-value text-danger" id="kpiRemain">0.00</div>
                        <div class="kpi-sub">قابل للتحصيل</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role-aware layout: Employee Quick Entry + Manager Table -->
        <div class="row g-3">
            <!-- الموظف: إدخال سريع -->
            <div class="col-12 col-xl-4" id="employeeQuickPanel">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <span><i class="bi bi-bolt me-1"></i> إدخال سريع (موظف)</span>
                        <span class="badge text-bg-info">توفير الوقت</span>
                    </div>
                    <div class="card-body">
                        <form id="frmQuick" class="row g-2">
                            <div class="col-12">
                                <label class="form-label">اسم وليّ الأمر</label>
                                <input name="ParentName" class="form-control" placeholder="مثال: أحمد محمد" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">الجوال</label>
                                <input name="ParentMobile" class="form-control" placeholder="05xxxxxxxx" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">الفرع</label>
                                <select name="BranchId" id="qBranch" class="form-select select2"></select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">السنة</label>
                                <select name="YearId" id="qYear" class="form-select select2"></select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">الطالب</label>
                                <input name="StudentName" class="form-control" placeholder="اسم الطالب" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">الصف</label>
                                <input name="StudentGrade" class="form-control" placeholder="مثال: خامس">
                            </div>
                            <div class="col-6">
                                <label class="form-label">المبلغ الإجمالي</label>
                                <input name="Total" type="number" step="0.01" class="form-control" value="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label">دفعة أولى</label>
                                <input name="FirstPay" type="number" step="0.01" class="form-control" value="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label">تاريخ بداية</label>
                                <input name="StartDate" type="date" class="form-control" required>
                            </div>
                            <div class="col-12 d-grid mt-2">
                                <button id="btnQuickSave" type="submit" class="btn btn-success">
                                    <i class="bi bi-check2-circle me-1"></i> حفظ فوري
                                </button>
                            </div>
                        </form>
                        <div class="small text-muted mt-2">* ينشئ عقدًا سريعًا بحقول أساسية ويمكن استكماله لاحقًا من شاشة المدير.</div>
                    </div>
                </div>
            </div>

            <!-- المدير: جدول شامل -->
            <div class="col-12 col-xl-8" id="managerTablePanel">
                <div class="card">
                    <div class="card-header"><i class="bi bi-table me-1"></i> جميع العقود</div>
                    <div class="card-body">
                        <table id="tblContracts" class="table table-striped w-100"></table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal: عقد كامل (إضافة/تعديل) -->
    <div class="modal fade" id="dlgContract" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="dlgTitle" class="modal-title">عقد جديد</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <form id="frmContract" class="row g-3">
                        <input type="hidden" name="Id" value="0" />

                        <div class="col-12 col-lg-4">
                            <label class="form-label">ولي الأمر</label>
                            <input name="ParentName" class="form-control" required />
                        </div>
                        <div class="col-12 col-lg-4">
                            <label class="form-label">الجوال</label>
                            <input name="ParentMobile" class="form-control" required />
                        </div>
                        <div class="col-6 col-lg-2">
                            <label class="form-label">الفرع</label>
                            <select name="BranchId" class="form-select select2"></select>
                        </div>
                        <div class="col-6 col-lg-2">
                            <label class="form-label">السنة</label>
                            <select name="YearId" class="form-select select2"></select>
                        </div>

                        <div class="col-6 col-lg-3">
                            <label class="form-label">الحالة</label>
                            <select name="Status" class="form-select">
                                <option value="Draft">مسودة</option>
                                <option value="Active">ساري</option>
                                <option value="Closed">مغلق</option>
                            </select>
                        </div>
                        <div class="col-6 col-lg-3">
                            <label class="form-label">تاريخ البداية</label>
                            <input name="StartDate" type="date" class="form-control" />
                        </div>
                        <div class="col-6 col-lg-3">
                            <label class="form-label">تاريخ الانتهاء</label>
                            <input name="EndDate" type="date" class="form-control" />
                        </div>
                        <div class="col-6 col-lg-3 d-flex align-items-center">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="Signed" id="chkSigned">
                                <label class="form-check-label" for="chkSigned">موقّع</label>
                            </div>
                        </div>

                        <div class="col-12 col-lg-6">
                            <label class="form-label">الأبناء</label>
                            <div id="studentsBox" class="border rounded p-2">
                                <div class="d-flex gap-2 mb-2">
                                    <input id="stName" class="form-control" placeholder="اسم الطالب">
                                    <input id="stGrade" class="form-control" placeholder="الصف">
                                    <button type="button" id="btnAddStudent" class="btn btn-outline-primary"><i class="bi bi-plus-lg"></i></button>
                                </div>
                                <ul id="studentsList" class="list-group small"></ul>
                            </div>
                        </div>

                        <div class="col-12 col-lg-6">
                            <label class="form-label">خطة الدفعات</label>
                            <div class="table-responsive border rounded">
                                <table class="table table-sm mb-0" id="tblPlan">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>تاريخ الاستحقاق</th>
                                            <th>المبلغ</th>
                                            <th>ملاحظة</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="d-flex gap-2 mt-2">
                                <input id="plDue" type="date" class="form-control">
                                <input id="plAmt" type="number" step="0.01" class="form-control" placeholder="0.00">
                                <input id="plNote" class="form-control" placeholder="ملاحظة">
                                <button type="button" id="btnAddPlan" class="btn btn-outline-primary"><i class="bi bi-plus-lg"></i></button>
                            </div>
                        </div>

                        <div class="col-4">
                            <label class="form-label">الإجمالي</label>
                            <input name="Total" type="number" step="0.01" class="form-control" value="0">
                        </div>
                        <div class="col-4">
                            <label class="form-label">المدفوع</label>
                            <input name="Paid" type="number" step="0.01" class="form-control" value="0">
                        </div>
                        <div class="col-4">
                            <label class="form-label">المتبقي</label>
                            <input readonly id="Remain" class="form-control-plaintext fw-bold" value="0.00">
                        </div>

                        <div class="col-12">
                            <label class="form-label">ملاحظات</label>
                            <textarea name="Notes" rows="2" class="form-control"></textarea>
                        </div>

                    </form>
                </div>
                <div class="modal-footer justify-content-between">
                    <div class="text-muted small">سيتم الحفظ محليًا (تجريبي).</div>
                    <div class="d-flex gap-2">
                        <button id="btnDlgDelete" class="btn btn-outline-danger"><i class="bi bi-trash"></i></button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button id="btnDlgSave" class="btn btn-primary"><i class="bi bi-check2-circle me-1"></i> حفظ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sticky footer -->
    <div id="stickyActions" class="sticky-footer">
        <div class="container d-flex justify-content-between align-items-center">
            <div id="footerSummary">جاهز.</div>
            <div>
                <button id="btnSaveAll" class="btn btn-success"><i class="bi bi-save2 me-1"></i> حفظ</button>
                <button id="btnCancel" class="btn btn-outline-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Vendor JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/dt-1.13.8/r-2.5.0/b-2.4.2/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>

    <!-- Your core (available per كلامك) -->
    <script src="/js/utils.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/forms.js"></script>
    <script src="/js/table.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/mock-data.js"></script>
    <script src="/js/menu-dynamic.js"></script>

    <!-- Page JS -->
    <script src="/js/parent-contracts.page.js"></script>
</body>
</html>
