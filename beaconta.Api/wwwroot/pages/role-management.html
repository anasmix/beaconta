<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>نظام المدارس | إدارة المجموعات والصلاحيات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Select2 + SweetAlert -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.min.css" rel="stylesheet" />
    <!-- خط Almarai -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Almarai',sans-serif;
            background: #f5f7fb
        }

        .appbar {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.06)
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(260px,320px) 1fr;
            gap: 1rem
        }

        @media(max-width:992px) {
            .layout {
                grid-template-columns: 1fr
            }
        }

        .cardx {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.06)
        }

        .role-item {
            cursor: pointer;
            border: 1px solid #eef1f6;
            border-radius: 12px;
            padding: .75rem 1rem
        }

            .role-item.active {
                outline: 2px solid #6366f1;
                background: #eef2ff
            }

        .perm-cat {
            border: 1px solid #eef1f6;
            border-radius: 12px;
            padding: .5rem .75rem;
            margin-bottom: .75rem
        }

        .perm-title {
            font-weight: 800
        }

        .perm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(230px,1fr));
            gap: .25rem .75rem;
            margin-top: .5rem
        }

        .tag {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            color: #3730a3;
            padding: .15rem .5rem;
            border-radius: 9999px;
            font-size: .75rem
        }

        .search input {
            border-radius: .6rem
        }

        .sticky-actions {
            position: sticky;
            bottom: 0;
            background: #fff;
            border-top: 1px solid #eee;
            border-radius: 0 0 16px 16px;
            padding: .75rem
        }

        .changed label {
            font-weight: 700
        }
    </style>
</head>
<body class="p-3 p-md-4">

    <div class="container-fluid mb-3">
        <div class="appbar p-3 p-md-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h4 class="fw-bold mb-1"><i class="bi bi-shield-lock me-2"></i>إدارة المجموعات والصلاحيات</h4>
                <div class="text-muted small">تحكم دقيق بمن يمكنه فعل ماذا داخل النظام</div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" id="btnCloneRole"><i class="bi bi-layers me-1"></i>نسخ صلاحيات</button>
                <button class="btn btn-primary" id="btnNewRole"><i class="bi bi-plus-circle me-1"></i>مجموعة جديدة</button>
                <button class="btn btn-outline-primary" id="btnRolesTable"><i class="bi bi-table me-1"></i>جدول المجموعات</button>
            </div>
        </div>
    </div>

    <div class="container-fluid layout">
        <!-- Sidebar: قائمة المجموعات -->
        <div class="cardx p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="fw-bold">المجموعات</div>
                <span class="tag" id="sidebarRoleUsersCount">— مستخدم</span>

            </div>
            <div class="mb-2">
                <select id="roleSelect" class="form-select"></select>
            </div>

            <div id="rolesList" class="d-grid gap-2"></div>
            <hr>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-info" id="viewRoleUsers">
                    <i class="bi bi-people me-1"></i>عرض المستخدمين
                </button>

                <button class="btn btn-outline-primary" id="renameRole"><i class="bi bi-pencil me-1"></i>إعادة تسمية</button>
                <button class="btn btn-outline-danger" id="deleteRole"><i class="bi bi-trash me-1"></i>حذف المجموعة</button>
            </div>
        </div>

        <!-- Main: لوحة الصلاحيات -->
        <div class="cardx p-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                <div class="search input-group" style="max-width:420px">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="permSearch" class="form-control" placeholder="ابحث عن صلاحية...">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light border" id="expandAll"><i class="bi bi-arrows-expand me-1"></i>توسيع الكل</button>
                    <button class="btn btn-light border" id="collapseAll"><i class="bi bi-arrows-collapse me-1"></i>طيّ الكل</button>
                    <button class="btn btn-light border" id="selectAll"><i class="bi bi-check2-all me-1"></i>تحديد الكل</button>
                    <button class="btn btn-light border" id="clearAll"><i class="bi bi-x-circle me-1"></i>مسح الكل</button>
                </div>
            </div>

            <div id="permPanel"></div>

            <div class="sticky-actions d-flex justify-content-between align-items-center">
                <div class="small text-muted">آخر تعديل: <span id="lastEdited">—</span> | <span id="dirtyState" class="text-danger d-none">تغييرات غير محفوظة</span></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light border" id="btnRevert"><i class="bi bi-arrow-counterclockwise me-1"></i>تراجع</button>
                    <button class="btn btn-primary" id="btnSave"><i class="bi bi-save2 me-1"></i>حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: مجموعة جديدة -->
    <div class="modal fade" id="newRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">إنشاء مجموعة جديدة</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">اسم المجموعة</label>
                    <input id="newRoleName" class="form-control" placeholder="مثال: مرشد تربوي">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light border" data-bs-dismiss="modal">إلغاء</button>
                    <button class="btn btn-primary" id="createRole">إنشاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: نسخ صلاحيات -->
    <div class="modal fade" id="cloneRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">نسخ صلاحيات من مجموعة أخرى</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">اختر المجموعة المصدر</label>
                    <select id="cloneFrom" class="form-select"></select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light border" data-bs-dismiss="modal">إلغاء</button>
                    <button class="btn btn-primary" id="applyClone">نسخ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: جدول المجموعات -->
    <div class="modal fade" id="rolesTableModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">جدول المجموعات</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table id="rolesTable" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم المجموعة</th>
                                <th>المستخدمون</th>
                                <th>عدد الصلاحيات</th>
                                <th>تاريخ الإنشاء</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: مستخدمو المجموعة -->
    <div class="modal fade" id="roleUsersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg border-0 rounded-4">

                <!-- Header -->
                <div class="modal-header bg-primary text-white py-3">
                    <i class="bi bi-people-fill me-2 fs-5"></i>
                    <h5 class="modal-title fw-bold">المستخدمون المرتبطون بالمجموعة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Body -->
                <div class="modal-body p-4">
                    <!-- تفاصيل المجموعة -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-muted">تفاصيل المجموعة</h6>
                        <div class="card border-0 shadow-sm rounded-3 mt-2">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-1 text-primary" id="roleName">اسم المجموعة</h6>
                                    <small class="text-muted">
                                        عدد المستخدمين: <span id="modalRoleUsersCount">0</span>

                                    </small>
                                </div>
                                <span class="badge bg-info text-dark px-3 py-2" id="roleCreatedAt">تاريخ الإنشاء</span>
                            </div>
                        </div>
                    </div>

                    <!-- جدول المستخدمين -->
                    <h6 class="fw-bold text-muted mb-3">قائمة المستخدمين</h6>
                    <div class="table-responsive">
                        <table class="table align-middle table-hover table-bordered shadow-sm" id="roleUsersTable">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>اسم المستخدم</th>
                                    <th>الاسم الكامل</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الهاتف</th>
                                    <th>آخر تسجيل دخول</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- يتم تعبئة المستخدمين عبر JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- مكتبات أساسية -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>

    <!-- ملفاتك المشتركة -->
    <script src="/js/loader.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/datatable.js"></script>
    <script src="/js/forms.js"></script>

    <!-- ملف الشاشة -->
    <script src="/js/roles.js"></script>
</body>
</html>
