<!doctype html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="utf-8" />
    <title>نظام المدارس — الرئيسية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- ====== CSS المطلوب منّك ====== -->
    <link rel="stylesheet"
          href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="icon" href="https://img.icons8.com/color/48/school.png" type="image/png">

    <!-- ملفاتك المحلية -->
    <link rel="stylesheet" href="css/main.css">
    <link href="css/easy-numpad.css" rel="stylesheet" />
    <link href="css/resizeable.css" rel="stylesheet" />
    <link href="css/index.css" rel="stylesheet" />

    <!-- أيقونات اختيارية -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        /* ===== AppBar (هيدر متدرّج، Material) ===== */
        .appbar {
            background: linear-gradient(135deg, #3f51b5 0%, #1e79d6 60%, #1b1c54 100%);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 1030;
        }

            .appbar .btn.btn-white {
                background: rgba(255,255,255,.15);
                color: #fff;
                border: 0;
                border-radius: 999px;
                padding: .35rem .6rem;
            }

                .appbar .btn.btn-white:hover {
                    background: rgba(255,255,255,.25);
                }

            .appbar .brand-mark {
                width: 38px;
                height: 38px;
                border-radius: 12px;
                background: rgba(255,255,255,.15);
                color: #fff;
                font-size: 1.1rem;
            }

            .appbar .brand-text small {
                letter-spacing: .3px;
            }

            .appbar .avatar {
                object-fit: cover;
                box-shadow: 0 4px 10px rgba(0,0,0,.25);
            }

        /* بحث */
        .appbar-search .search-field .input-group-text {
            background: rgba(255,255,255,.12);
            color: #fff;
            border: 0;
        }

        .appbar-search input.form-control {
            background: rgba(255,255,255,.12);
            border: 0;
            color: #fff;
        }

        .appbar-search input::placeholder {
            color: rgba(255,255,255,.85);
        }

        .appbar-search .kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,.12);
            color: #fff;
            font-size: .7rem;
            border-radius: 6px;
            padding: .1rem .35rem;
            margin-inline-start: .25rem;
        }

        /* Badges */
        .notify-badge {
            position: absolute;
            top: -6px;
            inset-inline-end: -8px;
            transform: translate(50%,-50%);
        }

        /* Nav scroller */
        .nav-scroller {
            margin-top: .25rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-pills.nav-pills-icons {
            display: flex;
            gap: .25rem;
            padding: .25rem 0;
        }

            .nav-pills.nav-pills-icons .nav-link {
                display: flex;
                align-items: center;
                gap: .45rem;
                color: #fff;
                opacity: .85;
                border-radius: 999px;
                padding: .4rem .8rem;
                transition: .18s;
                white-space: nowrap;
            }

                .nav-pills.nav-pills-icons .nav-link i {
                    font-size: 1rem;
                }

                .nav-pills.nav-pills-icons .nav-link:hover {
                    opacity: 1;
                    background: rgba(255,255,255,.12);
                }

                .nav-pills.nav-pills-icons .nav-link.active {
                    background: #fff;
                    color: #243047;
                    font-weight: 700;
                    box-shadow: 0 6px 18px rgba(0,0,0,.18);
                }

        /* تكيّف شاشات صغيرة */
        @media (max-width: 991.98px) {
            .appbar-search {
                display: none !important;
            }

            .nav-pills.nav-pills-icons .nav-link span {
                display: none;
            }
            /* أيقونات فقط على الموبايل */
            .nav-pills.nav-pills-icons .nav-link {
                padding: .45rem .6rem;
            }
        }
    </style>

    <style>
        :root {
            --sidebar-w: 300px;
            --radius: 16px;
            --chip-bg: #f6f8fb;
            --text: #0f172a;
            --muted: #6b7280;
        }

        [data-theme="dark"] {
            --chip-bg: rgba(255,255,255,.10);
            --text: #e6edf7;
            --muted: #a5b4c3;
        }

        html, body {
            height: 100%;
            background: #f5f7fb;
            color: var(--text);
        }

        .app {
            height: 100dvh;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        /* Top App Bar (Material) */
        .topbar {
            background: #3f51b5;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 1030;
            box-shadow: 0 8px 24px rgba(63,81,181,.25);
        }

            .topbar .brand {
                font-weight: 700;
                letter-spacing: .3px;
            }

            .topbar .nav-pills .nav-link {
                color: rgba(255,255,255,.9);
            }

                .topbar .nav-pills .nav-link.active {
                    background: #fff;
                    color: #1f2937;
                    border-radius: 999px;
                    font-weight: 700;
                }

        .btn-ghost {
            color: #fff;
            border: 1px solid rgba(255,255,255,.35);
            background: transparent
        }

            .btn-ghost:hover {
                background: rgba(255,255,255,.15)
            }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            gap: 12px;
            padding: 12px;
            height: 100%;
            min-height: 0;
        }

        @media (max-width: 991.98px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 0 10px 24px rgba(16,24,40,.10);
            overflow: auto;
            padding: 10px;
        }

            .sidebar .group {
                margin-bottom: 8px;
                border: 1px solid #eef2f7;
                border-radius: 12px;
                overflow: hidden
            }

                .sidebar .group.collapsed .group-items {
                    display: none
                }

            .sidebar .group-header {
                background: #f8fafc;
                padding: 10px 12px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

        .group-title {
            font-weight: 800;
            color: #6b7280;
            letter-spacing: .4px
        }

        .side-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px dashed #f1f5f9;
            cursor: pointer;
        }

            .side-item:last-child {
                border-bottom: 0
            }

            .side-item:hover {
                background: #f9fbff
            }

        .search {
            position: relative;
            margin: 6px
        }

            .search .bi-search {
                position: absolute;
                inset-inline-start: 10px;
                top: 50%;
                transform: translateY(-50%);
                opacity: .6
            }

            .search input {
                padding-inline-start: 34px;
                border-radius: 999px
            }

        /* Workspace */
        .workspace {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 10px;
            min-height: 0
        }

        .ws-tabs {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 0 10px 24px rgba(16,24,40,.10);
            padding: 6px;
            display: flex;
            gap: 8px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: var(--chip-bg);
            border: 1px solid transparent;
            user-select: none;
            flex: 0 0 auto;
            transition: .18s;
        }

            .chip.active {
                background: #111827;
                color: #fff;
                border-color: #111827
            }

            .chip .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: transparent
            }

            .chip.dirty .dot {
                background: #f59e0b
            }

            .chip .close {
                background: transparent;
                border: 0;
                color: inherit;
                opacity: .8
            }

                .chip .close:hover {
                    opacity: 1
                }

        .ws-content {
            position: relative;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 0 10px 24px rgba(16,24,40,.10);
            overflow: hidden;
            min-height: 0;
        }

        .frame {
            width: 100%;
            height: 100%;
            border: 0;
            display: block
        }

        #frames {
            height: 100%;
            min-height: 0
        }

        .empty {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            text-align: center;
            padding: 24px
        }

        .loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg,transparent,rgba(0,0,0,.05),transparent)
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(0,0,0,.2);
            border-top-color: #3f51b5;
            border-radius: 50%;
            animation: spin .85s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* Mobile small buttons */
        .mobile-actions {
            display: none
        }

        @media (max-width: 991.98px) {
            .desktop-sidebar {
                display: none
            }

            .mobile-actions {
                display: flex;
                gap: 6px
            }
        }

        /* Drawer (بديل Offcanvas لبوتستراب 4) */
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100dvh;
            width: min(92vw, 360px);
            background: #fff;
            box-shadow: -8px 0 24px rgba(0,0,0,.2);
            transform: translateX(100%);
            transition: transform .22s ease;
            z-index: 1040;
            display: flex;
            flex-direction: column;
        }

            .drawer.open {
                transform: translateX(0)
            }

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eef2f7
        }

        .drawer-body {
            padding: 8px;
            overflow: auto
        }

        /* وضع ملء الشاشة للإطارات */
        .iframe-fullscreen {
            position: fixed !important;
            top: 50px;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
        }
        /* لإخفاء عناصر واجهة المستخدم أثناء وضع ملء الشاشة */
        .fullscreen-hidden {
            display: none !important;
        }
    </style>


    <style>
        /* الشريط العلوي */
        #fullscreenBar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #3f51b5, #1ea6d6);
            color: #fff;
            display: none;
            z-index: 9999;
            box-shadow: 0 2px 6px rgba(0,0,0,.15);
        }

            #fullscreenBar .bar-content {
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 16px;
                font-size: 15px;
                font-weight: 600;
            }

            #fullscreenBar .exit-btn {
                background: #ef4444;
                border: none;
                color: #fff;
                padding: 6px 14px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: background .2s;
            }

                #fullscreenBar .exit-btn:hover {
                    background: #dc2626;
                }
        /* نزّل المحتوى عند ظهور الشريط */
        body.with-fullscreen-bar .app {
            margin-top: 50px; /* يساوي ارتفاع الشريط */
        }

        .bmd-form-group {
            padding-top: 0.75rem;
        }
    </style>


</head>
<body>
    <!-- شريط إنهاء ملء الشاشة -->
    <div id="fullscreenBar">
        <div class="bar-content">
            <div class="bar-title">
                <i class="bi bi-arrows-fullscreen"></i>
                <span>وضع ملء الشاشة مفعل</span>
            </div>
            <button id="exitFullscreenBtn" class="exit-btn">
                <i class="bi bi-x-circle"></i> إنهاء
            </button>
        </div>
    </div>



    <!-- زر التكبير/التصغير
    <button id="iframeFullscreenToggle" title="تكبير/تصغير الشاشة"
      style="position: fixed; top: 12px; left: 12px; z-index: 5000;
             background: rgba(0,0,0,0.6); color:#fff; border:none;
             border-radius:50%; width:40px; height:40px;
             display:flex; align-items:center; justify-content:center;">
      <i class="bi bi-arrows-fullscreen"></i>
    </button>
    -->

    <div class="app">

        <!-- Top Bar -->
        <header class="appbar shadow-lg">
            <div class="container-fluid">

                <!-- الصف العلوي: قائمة/شعار + بحث + إجراءات -->
                <div class="d-flex align-items-center justify-content-between py-2">
                    <div class="d-flex align-items-center">
                        <!-- زر القائمة للموبايل -->
                        <button id="btnMenu" class="btn btn-white btn-sm d-inline-flex d-lg-none mr-2" title="القائمة">
                            <i class="bi bi-list"></i>
                        </button>

                        <!-- الشعار -->
                        <div class="brand d-flex align-items-center">
                            <span class="brand-mark d-inline-flex align-items-center justify-content-center mr-2">
                                <i class="bi bi-mortarboard"></i>
                            </span>
                            <div class="brand-text">
                                <div class="h6 font-weight-bold mb-0">نظام المدارس</div>
                                <small class="text-white-50">لوحة الإدارة</small>
                            </div>
                        </div>
                    </div>


                    <!-- بحث سريع (يختصر على الموبايل) -->
                    <form class="appbar-search d-none d-md-flex align-items-center flex-grow-1 mx-3" role="search" onsubmit="return false;">
                        <div class="form-group bmd-form-group mb-0 w-100">
                            <div class="input-group input-group-sm search-field">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                </div>
                                <input type="text" class="form-control" placeholder="ابحث في الطلاب، العقود، المدفوعات…" aria-label="بحث عام">
                                <div class="input-group-append d-none d-lg-flex">
                                    <span class="kbd">Ctrl</span><span class="kbd">K</span>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- إجراءات -->
                    <div class="d-flex align-items-center">


                        <!-- 🔹 الإجراءات + اختيار السنة -->
                        <div class="d-flex align-items-center">

                            <!-- زر اختيار السنة (نفس ستايل الأزرار) -->
                            <div class="dropdown mr-2">
                                <button class="btn btn-white btn-sm d-flex align-items-center" id="yearDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="bi bi-calendar3 mr-1"></i>
                                    <span id="currentYear">2025 / 2026</span>
                                    <i class="bi bi-chevron-down ml-1"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right animate__animated animate__fadeIn" aria-labelledby="yearDropdown">
                                    <a class="dropdown-item" href="#" data-value="2025">2025 / 2026</a>
                                    <a class="dropdown-item" href="#" data-value="2024">2024 / 2025</a>
                                    <a class="dropdown-item" href="#" data-value="2023">2023 / 2024</a>
                                </div>
                            </div>

                            <!-- زر تبديل الثيم -->
                            <button id="themeBtn" class="btn btn-white btn-sm mr-1" title="تبديل الوضع">
                                <i class="bi bi-moon-stars"></i>
                            </button>

                            <!-- زر الإشعارات -->
                            <button class="btn btn-white btn-sm mr-1" title="الإشعارات" data-toggle="tooltip">
                                <span class="position-relative d-inline-flex align-items-center justify-content-center">
                                    <i class="bi bi-bell"></i>
                                    <span class="badge badge-pill badge-danger notify-badge">3</span>
                                </span>
                            </button>

                            <!-- زر تحديث التبويب -->
                            <button id="reloadActive" class="btn btn-white btn-sm mr-2" title="تحديث التبويب">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>

                            <!-- زر التكبير/التصغير -->
                            <button id="iframeFullscreenToggle" class="btn btn-white btn-sm mr-2" title="تكبير/تصغير الشاشة">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </div>






                        <!-- قائمة المستخدم -->
                        <div class="dropdown">
                            <button class="btn btn-white btn-sm d-inline-flex align-items-center" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <img src="https://i.pravatar.cc/40?img=12" class="avatar rounded-circle ml-2" alt="المستخدم" width="28" height="28">
                                <span class="d-none d-sm-inline">مدير النظام</span>
                                <i class="bi bi-chevron-down ml-1"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right animate__animated animate__fadeIn">
                                <a class="dropdown-item" href="#"><i class="bi bi-person mr-2"></i>الملف الشخصي</a>
                                <a class="dropdown-item" href="#"><i class="bi bi-gear mr-2"></i>الإعدادات</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right mr-2"></i>تسجيل الخروج</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الصف السفلي: تنقّل أيقوني قابل للتمرير -->
                <nav class="nav-scroller">
                    <ul id="mainTabs" class="nav nav-pills nav-pills-icons">
                        <li class="nav-item"><a class="nav-link active" data-main="dashboard" href="#"><i class="bi bi-speedometer2"></i><span>الرئيسية</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="schoolYears" href="#"><i class="bi bi-calendar3"></i><span>إدارة السنوات الدراسية</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="schools" href="#"><i class="bi bi-calendar3"></i><span>المدارس</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="students" href="#"><i class="bi bi-people"></i><span>الطلاب</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="academia" href="#"><i class="bi bi-book"></i><span>الأكاديمية </span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="contracts" href="#"><i class="bi bi-file-earmark-text"></i><span>العقود</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="finance" href="#"><i class="bi bi-cash-coin"></i><span>المالية</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="hr" href="#"><i class="bi bi-person-badge"></i><span>شؤون الموظفين</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="transport" href="#"><i class="bi bi-bus-front"></i><span>المواصلات</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="warehouses" href="#"><i class="bi bi-box-seam"></i><span>المستودعات</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="archiving" href="#"><i class="bi bi-archive"></i><span>الأرشفة</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="notes" href="#"><i class="bi bi-journal-text"></i><span>الملاحظات والقضايا</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="circulars" href="#"><i class="bi bi-envelope-open"></i><span>التعاميم الإدارية</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="permissions" href="#"><i class="bi bi-shield-lock"></i><span>الصلاحيات</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="monitoring" href="#"><i class="bi bi-graph-up"></i><span>المراقبة</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="centralReports" href="#"><i class="bi bi-bar-chart-line"></i><span>نظام التقارير المركزي</span></a></li>
                        <li class="nav-item"><a class="nav-link" data-main="upperManagement" href="#"><i class="bi bi-graph-up-arrow"></i><span>الإدارة العليا</span></a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Layout -->
        <div class="layout container-fluid">
            <!-- Sidebar (Desktop) -->
            <aside class="sidebar desktop-sidebar">
                <div class="search">
                    <i class="bi bi-search"></i>
                    <input id="sideSearch" class="form-control form-control-sm" type="search" placeholder="ابحث…">
                </div>
                <div id="sidebar"></div>
            </aside>

            <!-- Workspace -->
            <section class="workspace">
                <div class="ws-tabs" id="tabsBar" aria-label="تبويبات العمل"></div>
                <div class="ws-content">
                    <div class="empty">افتح صفحة من القائمة — ستظهر هنا بدون تحديث كامل، وتبقى حالتها محفوظة عند التنقّل.</div>
                    <div id="frames" class="h-100 position-relative" role="region" aria-label="محتوى التبويب"></div>
                    <!-- زر تكبير/تصغير الإطار النشط -->

                </div>
            </section>
        </div>

    </div>

    <!-- Drawer Sidebar (Mobile) -->
    <div id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <strong>القائمة</strong>
            <button id="btnCloseDrawer" class="btn btn-link"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="drawer-body">
            <div class="search mb-2">
                <i class="bi bi-search"></i>
                <input id="sideSearchMobile" class="form-control form-control-sm" type="search" placeholder="ابحث…">
            </div>
            <div id="sidebarMobile"></div>
            <hr>
            <ul id="mainTabsMobile" class="nav nav-pills">
                <li class="nav-item"><a class="nav-link active" data-main="dashboard" href="#">الرئيسية</a></li>
                <li class="nav-item"><a class="nav-link" data-main="schoolYears" href="#">إدارة السنوات الدراسية</a></li>
                <li class="nav-item"><a class="nav-link" data-main="students" href="#">الطلاب</a></li>
                <li class="nav-item"><a class="nav-link" data-main="academia" href="#">الأكاديمية </a></li>
                <li class="nav-item"><a class="nav-link" data-main="contracts" href="#">العقود</a></li>
                <li class="nav-item"><a class="nav-link" data-main="finance" href="#">المالية</a></li>
                <li class="nav-item"><a class="nav-link" data-main="hr" href="#">شؤون الموظفين</a></li>
                <li class="nav-item"><a class="nav-link" data-main="transport" href="#">المواصلات</a></li>
                <li class="nav-item"><a class="nav-link" data-main="warehouses" href="#">المستودعات</a></li>
                <li class="nav-item"><a class="nav-link" data-main="archiving" href="#">الأرشفة</a></li>
                <li class="nav-item"><a class="nav-link" data-main="notes" href="#">الملاحظات والقضايا</a></li>
                <li class="nav-item"><a class="nav-link" data-main="circulars" href="#">التعاميم الإدارية</a></li>
                <li class="nav-item"><a class="nav-link" data-main="permissions" href="#">الصلاحيات</a></li>
                <li class="nav-item"><a class="nav-link" data-main="monitoring" href="#">المراقبة</a></li>
                <li class="nav-item"><a class="nav-link" data-main="centralReports" href="#">نظام التقارير المركزي</a></li>
                <li class="nav-item"><a class="nav-link" data-main="upperManagement" href="#">الإدارة العليا</a></li>
            </ul>
        </div>
    </div>


    <!-- ====== Scripts: jQuery + Popper + Bootstrap 4 + Material + Toastr ====== -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/bootstrap-material-design@4.1.1/dist/js/bootstrap-material-design.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- JS مشتركة -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/forms.js"></script>
    <script src="js/home.js"></script>

    <!-- ✅ تحميل القوائم الديناميكية -->
    <script src="js/menu-dynamic.js"></script>

    <script>
        /* ===== تفعيل Bootstrap Material Design ===== */
        $(function () { $('body').bootstrapMaterialDesign(); });

        /* ===== بيانات القائمة ===== */
        const MENU = {
            dashboard: { title: 'الرئيسية', groups: [{ title: 'لوحة التحكم', items: [{ id: 'dashboard-overview', icon: 'bi-speedometer2', title: 'الرئيسية', desc: 'نظرة عامة', url: 'pages/dashboard.html' }] }] },
            schoolYears: { title: 'إدارة السنوات الدراسية', groups: [{ title: 'عمليات', items: [{ id: 'new-year', icon: 'bi-calendar-plus', title: 'إنشاء سنة جديدة', desc: '', url: 'pages/new-year.html' }, { id: 'terms-calendar', icon: 'bi-calendar-week', title: 'تحديد الفصول والتقويم', desc: '', url: '#' }, { id: 'rollover', icon: 'bi-arrows-collapse', title: 'ترحيل الطلاب والعقود', desc: '', url: '#' }, { id: 'link-fees-curricula', icon: 'bi-link-45deg', title: 'ربط الرسوم والمناهج', desc: '', url: '#' }, { id: 'annual-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير سنوية', desc: '', url: '#' }] }] },
            students: { title: 'الطلاب', groups: [{ title: 'إدارة الطلاب', items: [{ id: 'registration', icon: 'bi-person-plus', title: 'التسجيل والملفات', desc: '', url: '#' }, { id: 'attendance', icon: 'bi-calendar-check', title: 'الحضور والغياب', desc: '', url: '#' }, { id: 'subjects-curricula', icon: 'bi-bar-chart-line', title: 'الأداء الأكاديمي', desc: '', url: '#' }, { id: 'behavior', icon: 'bi-emoji-smile', title: 'السلوك والأنشطة', desc: '', url: '#' }, { id: 'graduation', icon: 'bi-person-check', title: 'التخرج والتحويل', desc: '', url: '#' }] }, { title: 'الكتب الرسمية', items: [{ id: 'certificate-transfer', icon: 'bi-file-earmark-text', title: 'شهادة انتقال', desc: '', url: '#' }, { id: 'certificate-proof', icon: 'bi-file-earmark-text', title: 'شهادة إثبات طالب', desc: '', url: '#' }, { id: 'phase-completion', icon: 'bi-file-earmark-text', title: 'شهادة إنهاء مرحلة', desc: '', url: '#' }, { id: 'good-conduct', icon: 'bi-file-earmark-text', title: 'شهادة حسن سلوك', desc: '', url: '#' }] }, { title: 'إدارة وثائق الطلاب', items: [{ id: 'docs-checklist', icon: 'bi-card-checklist', title: 'قائمة الوثائق المطلوبة', desc: '', url: '#' }, { id: 'docs-entry', icon: 'bi-inbox', title: 'إدخال واستلام الوثائق', desc: '', url: '#' }, { id: 'docs-upload', icon: 'bi-upload', title: 'رفع نسخ إلكترونية وربطها بالطالب', desc: '', url: '#' }, { id: 'docs-store', icon: 'bi-box', title: 'مستودع الوثائق الأصلية', desc: '', url: '#' }, { id: 'docs-alerts', icon: 'bi-bell', title: 'تنبيهات النواقص + تقارير متابعة', desc: '', url: '#' }] }] },
            schools: {
                title: 'إدارة المدارس',
                groups: [
                    {
                        title: 'المدارس والمراحل',
                        items: [
                            { id: 'manage-schools', icon: 'bi-building', title: 'المدارس', desc: '', url: 'pages/schools.html' },
                            { id: 'manage-stages', icon: 'bi-diagram-3', title: 'المراحل والصفوف', desc: '', url: 'pages/stages.html' }
                        ]
                    }
                ]
            },

            academia: { title: 'الأكاديمية', groups: [{ title: 'الأكاديمية ', items: [{ id: 'subjects-curricula', icon: 'bi-journal-bookmark', title: 'المواد والمناهج', desc: '', url: '#' }, { id: 'weekly-plans', icon: 'bi-calendar3-week', title: 'الخطط الأسبوعية', desc: '', url: '#' }, { id: 'exams', icon: 'bi-pencil-square', title: 'الامتحانات', desc: '', url: '#' }, { id: 'e-learning', icon: 'bi-laptop', title: 'التعليم الإلكتروني', desc: '', url: '#' }, { id: 'automatic-schedules', icon: 'bi-table', title: 'الجداول الآلية', desc: '', url: '#' }, { id: 'performance-reports', icon: 'bi-bar-chart', title: 'تقارير الأداء', desc: '', url: '#' }] }] },
            contracts: { title: 'العقود', groups: [{ title: 'أنواع العقود', items: [{ id: 'parent-contracts', icon: 'bi-file-earmark-text', title: 'عقود أولياء الأمور', desc: '', url: '#' }, { id: 'staff-contracts', icon: 'bi-file-earmark-text', title: 'عقود الموظفين', desc: '', url: '#' }, { id: 'supplier-contracts', icon: 'bi-file-earmark-text', title: 'عقود الموردين', desc: '', url: '#' }] }] },
            finance: { title: 'المالية', groups: [{ title: 'المالية', items: [{ id: 'installments-bills', icon: 'bi-receipt', title: 'الأقساط والفواتير', desc: '', url: '#' }, { id: 'payment-vouchers', icon: 'bi-cash-coin', title: 'سندات القبض', desc: '', url: '#' }, { id: 'budget-reports', icon: 'bi-file-earmark-bar-graph', title: 'الميزانية والتقارير', desc: '', url: '#' }, { id: 'national-billing', icon: 'bi-link-45deg', title: 'الربط مع الفوترة الوطنية', desc: '', url: '#' }] }, { title: 'التحصيل القانوني', items: [{ id: 'follow-defaulters', icon: 'bi-clock-history', title: 'متابعة المتأخرين', desc: '', url: '#' }, { id: 'warnings', icon: 'bi-exclamation-triangle', title: 'الإنذارات', desc: '', url: '#' }, { id: 'cases-courts', icon: 'bi-gavel', title: 'القضايا والمحاكم', desc: '', url: '#' }, { id: 'payment-status', icon: 'bi-check-circle', title: 'تحديث حالة السداد', desc: '', url: '#' }] }] },
            hr: { title: 'شؤون الموظفين', groups: [{ title: 'شؤون الموظفين', items: [{ id: 'personal-files', icon: 'bi-person-badge', title: 'الملفات الشخصية', desc: '', url: '#' }, { id: 'salaries-advances', icon: 'bi-cash-stack', title: 'الرواتب والسلف', desc: '', url: '#' }, { id: 'rewards-sanctions', icon: 'bi-gift', title: 'المكافآت والعقوبات', desc: '', url: '#' }, { id: 'leaves-promotions', icon: 'bi-arrow-up-right-circle', title: 'الإجازات والترقيات', desc: '', url: '#' }, { id: 'attendance-shifts', icon: 'bi-clock', title: 'الحضور والانصراف + المناوبات', desc: '', url: '#' }] }, { title: 'التوظيف', items: [{ id: 'vacancy-announcement', icon: 'bi-megaphone', title: 'الإعلان عن الشواغر', desc: '', url: '#' }, { id: 'application-receipt', icon: 'bi-envelope-open', title: 'استقبال الطلبات', desc: '', url: '#' }, { id: 'screening-interviews', icon: 'bi-clipboard-check', title: 'فرز ومقابلات', desc: '', url: '#' }, { id: 'convert-to-employee', icon: 'bi-person-check', title: 'التحويل إلى موظف', desc: '', url: '#' }] }] },
            transport: { title: 'المواصلات', groups: [{ title: 'المواصلات', items: [{ id: 'buses-drivers', icon: 'bi-bus-front', title: 'إدارة الباصات والسائقين', desc: '', url: '#' }, { id: 'routes', icon: 'bi-map', title: 'الجولات والمسارات', desc: '', url: '#' }, { id: 'gps-tracking', icon: 'bi-geo-alt', title: 'تتبع GPS', desc: '', url: '#' }, { id: 'parent-notifications', icon: 'bi-bell', title: 'إشعارات أولياء الأمور', desc: '', url: '#' }] }] },
            warehouses: { title: 'المستودعات', groups: [{ title: 'المستودعات', items: [{ id: 'book-management', icon: 'bi-journal', title: 'إدارة الكتب', desc: '', url: '#' }, { id: 'uniform-management', icon: 'bi-shirt', title: 'إدارة الزي', desc: '', url: '#' }, { id: 'pos-students', icon: 'bi-bag', title: 'البيع (POS للطلاب)', desc: '', url: '#' }, { id: 'inventory-alerts', icon: 'bi-exclamation-circle', title: 'الجرد والتنبيهات', desc: '', url: '#' }] }, { title: 'المشتريات', items: [{ id: 'purchase-requests', icon: 'bi-file-earmark-plus', title: 'طلبات الشراء', desc: '', url: '#' }, { id: 'price-offers', icon: 'bi-tags', title: 'عروض الأسعار', desc: '', url: '#' }, { id: 'purchase-orders', icon: 'bi-cart', title: 'أوامر الشراء', desc: '', url: '#' }, { id: 'receiving', icon: 'bi-box-arrow-in-down', title: 'استلام وربط بالمستودع', desc: '', url: '#' }, { id: 'finance-link', icon: 'bi-link-45deg', title: 'الربط مع المالية', desc: '', url: '#' }] }, { title: 'المقصف الذكي', items: [{ id: 'canteen-products', icon: 'bi-list-ul', title: 'قائمة المنتجات والمخزون', desc: '', url: '#' }, { id: 'canteen-pos', icon: 'bi-credit-card', title: 'نقطة البيع (POS)', desc: '', url: '#' }, { id: 'student-wallet', icon: 'bi-wallet', title: 'الدفع بمحفظة الطالب / بطاقة NFC', desc: '', url: '#' }, { id: 'parent-notifications-canteen', icon: 'bi-bell', title: 'إشعارات لولي الأمر', desc: '', url: '#' }, { id: 'sales-reports', icon: 'bi-graph-up-arrow', title: 'تقارير المبيعات والأرباح', desc: '', url: '#' }, { id: 'healthy-options', icon: 'bi-heart', title: 'خيارات التغذية الصحية', desc: '', url: '#' }] }] },
            archiving: { title: 'الأرشفة', groups: [{ title: 'الأرشفة', items: [{ id: 'student-files-archive', icon: 'bi-folder', title: 'ملفات الطلاب', desc: '', url: '#' }, { id: 'contracts-archive', icon: 'bi-file-earmark-zip', title: 'العقود', desc: '', url: '#' }, { id: 'admin-documents', icon: 'bi-file-earmark-richtext', title: 'الوثائق الإدارية', desc: '', url: '#' }, { id: 'outgoing-incoming-books', icon: 'bi-journal-arrow-down', title: 'الكتب الصادرة والواردة', desc: '', url: '#' }, { id: 'official-copies', icon: 'bi-journal-arrow-up', title: 'نسخ الكتب الرسمية + الوثائق', desc: '', url: '#' }] }] },
            notes: { title: 'الملاحظات والقضايا', groups: [{ title: 'الملاحظات والقضايا', items: [{ id: 'parents-complaints', icon: 'bi-chat-dots', title: 'شكاوى أولياء الأمور', desc: '', url: '#' }, { id: 'student-cases', icon: 'bi-people', title: 'قضايا الطلاب', desc: '', url: '#' }, { id: 'staff-cases', icon: 'bi-person', title: 'قضايا الموظفين', desc: '', url: '#' }] }] },
            circulars: { title: 'التعاميم الإدارية', groups: [{ title: 'التعاميم الإدارية', items: [{ id: 'issue-circulars', icon: 'bi-send', title: 'إصدار التعاميم', desc: '', url: '#' }, { id: 'follow-implementation', icon: 'bi-check2-square', title: 'متابعة التنفيذ', desc: '', url: '#' }] }] },
            permissions: { title: 'الصلاحيات', groups: [{ title: 'الصلاحيات', items: [{ id: 'user-management', icon: 'bi-person-lines-fill', title: 'إدارة المستخدمين', desc: '', url: '#' }, { id: 'role-management', icon: 'bi-shield-lock', title: 'المجموعات والصلاحيات التفصيلية', desc: '', url: '#' }] }] },
            monitoring: { title: 'المراقبة', groups: [{ title: 'المراقبة', items: [{ id: 'logs-tracking', icon: 'bi-hdd-network', title: 'تتبع العمليات (Logs)', desc: '', url: '#' }, { id: 'performance-reports-mon', icon: 'bi-bar-chart-line', title: 'تقارير الأداء', desc: '', url: '#' }] }] },
            centralReports: { title: 'نظام التقارير المركزي', groups: [{ title: 'نظام التقارير المركزي', items: [{ id: 'student-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير الطلاب', desc: '', url: '#' }, { id: 'academia-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير الأكاديميا', desc: '', url: '#' }, { id: 'contracts-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير العقود', desc: '', url: '#' }, { id: 'finance-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير المالية', desc: '', url: '#' }, { id: 'hr-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير الموظفين', desc: '', url: '#' }, { id: 'transport-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير المواصلات', desc: '', url: '#' }, { id: 'warehouses-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير المستودعات والمقصف', desc: '', url: '#' }, { id: 'archiving-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير الأرشفة', desc: '', url: '#' }, { id: 'notes-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير الملاحظات والقضايا', desc: '', url: '#' }, { id: 'management-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير الإدارة العليا (KPIs + AI + What-if)', desc: '', url: '#' }] }] },
            upperManagement: { title: 'الإدارة العليا', groups: [{ title: 'الإدارة العليا', items: [{ id: 'executive-dashboard', icon: 'bi-speedometer2', title: 'Executive Dashboard', desc: '', url: '#' }, { id: 'kpi', icon: 'bi-bar-chart', title: 'مؤشرات الأداء KPIs', desc: '', url: '#' }, { id: 'strategic-reports', icon: 'bi-file-earmark-bar-graph', title: 'تقارير استراتيجية', desc: '', url: '#' }] }] }
        };

        /* ===== الحالة ===== */
        const KEY = 'school_shell_material_v1';
        let state = { theme: document.documentElement.dataset.theme || 'light', main: 'dashboard', tabs: [] };
        // tabs: [{id,title,url,active,dirty}]

        function save() { localStorage.setItem(KEY, JSON.stringify(state)); }
        function load() {
            const raw = localStorage.getItem(KEY); if (!raw) return;
            try {
                const s = JSON.parse(raw);
                state = Object.assign(state, s);
                document.documentElement.dataset.theme = state.theme;
                syncThemeIcon();
            } catch { }
        }

        /* ===== بناء Sidebar (desktop/mobile) ===== */
        function buildSidebar(container) {
            container.innerHTML = '';
            const sec = MENU[state.main];
            sec.groups.forEach((g, gi) => {
                const box = document.createElement('div'); box.className = 'group';
                box.innerHTML = `
                <div class="group-header" data-toggle="${gi}">
                  <div class="group-title">${g.title}</div>
                  <i class="bi bi-chevron-down"></i>
                </div>
                <div class="group-items"></div>
              `;
                const wrap = box.querySelector('.group-items');
                g.items.forEach(it => {
                    const row = document.createElement('div');
                    row.className = 'side-item';
                    row.dataset.open = it.id; row.dataset.url = it.url; row.dataset.title = it.title;
                    row.innerHTML = `<i class="bi ${it.icon}"></i><div><div class="font-weight-bold">${it.title}</div><small class="text-muted">${it.desc || ''}</small></div>`;
                    row.addEventListener('click', () => {
                        openTab({ id: it.id, title: it.title, url: it.url });
                        toastInfo('تم فتح: ' + it.title);
                        drawerClose(); // إن كان من الموبايل
                    });
                    wrap.appendChild(row);
                });
                container.appendChild(box);
            });

            container.querySelectorAll('.group-header').forEach(h => {
                h.addEventListener('click', () => h.parentElement.classList.toggle('collapsed'));
            });
        }

        /* ===== Workspace Tabs ===== */
        const tabsBar = document.getElementById('tabsBar');
        const frames = document.getElementById('frames');

        function renderTabs() {
            tabsBar.innerHTML = '';
            if (state.tabs.length === 0) document.querySelector('.empty').style.display = 'flex';
            else document.querySelector('.empty').style.display = 'none';

            state.tabs.forEach(t => {
                const chip = document.createElement('div');
                chip.className = `chip ${t.active ? 'active' : ''} ${t.dirty ? 'dirty' : ''} animate__animated animate__fadeIn`;
                chip.dataset.tab = t.id;
                chip.innerHTML = `
                <span class="dot"></span>
                <i class="bi bi-window-stack"></i>
                <span>${t.title}</span>
                <button class="close" title="إغلاق"><i class="bi bi-x-lg"></i></button>
              `;
                chip.addEventListener('click', (e) => {
                    if (e.target.closest('.close')) { tryClose(t.id); return; }
                    activateTab(t.id);
                });
                tabsBar.appendChild(chip);
            });

            // إظهار/إخفاء الإطارات
            [...frames.querySelectorAll('iframe')].forEach(f => {
                const id = f.dataset.tab;
                f.style.display = state.tabs.find(x => x.id === id)?.active ? 'block' : 'none';
            });
        }

        function ensureFrame(tab) {
            let f = frames.querySelector(`iframe[data-tab="${tab.id}"]`);
            if (!f) {
                // Show a loader while the iframe is loading
                const ld = document.createElement('div');
                ld.className = 'loader';
                ld.dataset.loader = tab.id;
                ld.innerHTML = '<div class="spinner"></div>';
                frames.appendChild(ld);

                f = document.createElement('iframe');
                f.className = 'frame';
                f.dataset.tab = tab.id;
                /*
                 * Determine which URL to load. If the menu entry did not specify a URL
                 * (or it is set to "#"), fall back to a convention where the page for
                 * this tab lives under the `pages/` directory and is named after the
                 * tab's id. This allows the organizational structure to be defined in
                 * one place while keeping each page separate. A query parameter with
                 * the tab ID is always appended for context.
                 */
                const fallbackUrl = !tab.url || tab.url === '#' ? `pages/${tab.id}.html` : tab.url;
                const url = fallbackUrl.includes('?')
                    ? `${fallbackUrl}&tabId=${encodeURIComponent(tab.id)}`
                    : `${fallbackUrl}?tabId=${encodeURIComponent(tab.id)}`;
                f.src = url;
                // Allow forms and scripts inside the iframe but isolate origin
                f.setAttribute('sandbox', 'allow-forms allow-same-origin allow-scripts');
                f.addEventListener('load', () => frames.querySelector(`[data-loader="${tab.id}"]`)?.remove());
                frames.appendChild(f);
            }
        }

        function openTab({ id, title, url }) {
            const ex = state.tabs.find(t => t.id === id);
            state.tabs.forEach(t => t.active = false);
            if (ex) { ex.active = true; ensureFrame(ex); }
            else {
                const t = { id, title, url, active: true, dirty: false };
                state.tabs.push(t); ensureFrame(t);
            }
            save(); renderTabs();
        }

        function activateTab(id) { state.tabs.forEach(t => t.active = (t.id === id)); save(); renderTabs(); }

        function setDirty(id, dirty = true) { const t = state.tabs.find(x => x.id === id); if (!t) return; t.dirty = !!dirty; save(); renderTabs(); }
        function tryClose(id) {
            const t = state.tabs.find(x => x.id === id); if (!t) return;
            if (t.dirty && !confirm('هناك تغييرات غير محفوظة — إغلاق التبويب؟')) return;
            closeTab(id);
        }
        function closeTab(id) {
            const idx = state.tabs.findIndex(t => t.id === id); if (idx < 0) return;
            const wasActive = state.tabs[idx].active;
            frames.querySelector(`[data-loader="${id}"]`)?.remove();
            frames.querySelector(`iframe[data-tab="${id}"]`)?.remove();
            state.tabs.splice(idx, 1);
            if (wasActive && state.tabs.length) state.tabs[state.tabs.length - 1].active = true;
            save(); renderTabs();
        }

        /* ===== أدوات صغيرة ===== */
        function toastInfo(msg) { toastr.info(msg, 'معلومة', { timeOut: 1400, positionClass: 'toast-bottom-left' }); }
        function syncThemeIcon() {
            const dark = document.documentElement.dataset.theme === 'dark';
            document.getElementById('themeBtn').innerHTML = `<i class="bi ${dark ? 'bi-sun' : 'bi-moon-stars'}"></i>`;
        }

        /* ===== Drawer (Mobile) ===== */
        const drawer = document.getElementById('drawer');
        const btnMenu = document.getElementById('btnMenu');
        const btnCloseDrawer = document.getElementById('btnCloseDrawer');
        function drawerOpen() { drawer.classList.add('open'); drawer.setAttribute('aria-hidden', 'false'); }
        function drawerClose() { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden', 'true'); }
        btnMenu.addEventListener('click', drawerOpen);
        btnCloseDrawer.addEventListener('click', drawerClose);
        drawer.addEventListener('click', (e) => { if (e.target === drawer) drawerClose(); });

        /* ===== Main Tabs (desktop/mobile) ===== */
        function bindMainTabs(containerId) {
            const root = document.getElementById(containerId);
            root.addEventListener('click', (e) => {
                const a = e.target.closest('.nav-link'); if (!a) return;
                e.preventDefault();
                root.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
                a.classList.add('active');
                state.main = a.dataset.main; save();
                buildSidebar(document.getElementById('sidebar'));
                buildSidebar(document.getElementById('sidebarMobile'));
            });
        }
        bindMainTabs('mainTabs');
        bindMainTabs('mainTabsMobile');

        /* ===== بحث جانبي ===== */
        function bindSearch(boxId, listRootId) {
            const el = document.getElementById(boxId);
            el?.addEventListener('input', function () {
                const q = this.value.trim().toLowerCase();
                document.querySelectorAll('#' + listRootId + ' .side-item').forEach(n => {
                    const t = (n.dataset.title || '').toLowerCase();
                    n.style.display = t.includes(q) ? '' : 'none';
                });
            });
        }
        bindSearch('sideSearch', 'sidebar');
        bindSearch('sideSearchMobile', 'sidebarMobile');

        /* ===== أزرار أعلى الشريط ===== */
        document.getElementById('themeBtn').addEventListener('click', () => {
            const isDark = document.documentElement.dataset.theme === 'dark';
            document.documentElement.dataset.theme = isDark ? 'light' : 'dark';
            state.theme = document.documentElement.dataset.theme; save(); syncThemeIcon();
        });

        document.getElementById('reloadActive').addEventListener('click', () => {
            const a = state.tabs.find(t => t.active); if (!a) return;
            const frame = frames.querySelector(`iframe[data-tab="${a.id}"]`); if (!frame) return;
            const ld = document.createElement('div'); ld.className = 'loader'; ld.dataset.loader = a.id; ld.innerHTML = '<div class="spinner"></div>';
            frames.appendChild(ld);
            frame.contentWindow.location.reload();
            frame.addEventListener('load', () => frames.querySelector(`[data-loader="${a.id}"]`)?.remove(), { once: true });
        });

        /* ===== رسائل من الصفحات الفرعية (openTab / dirty) ===== */
        window.addEventListener('message', (e) => {
            const d = e.data || {};
            if (d.type === 'openTab' && d.id && d.title && d.url) {
                openTab({ id: d.id, title: d.title, url: d.url });
                toastInfo('فتح: ' + d.title);
            }
            if (d.type === 'dirty' && d.tabId) { setDirty(d.tabId, !!d.value); }
        });

        /* ===== إقلاع ===== */
        (function boot() {
            load();
            buildSidebar(document.getElementById('sidebar'));
            buildSidebar(document.getElementById('sidebarMobile'));
            state.tabs.forEach(t => ensureFrame(t));
            if (state.tabs.length === 0) {
                // On first load, open the home tab. Use the dashboard overview ID so that
                // the URL convention described in ensureFrame() applies correctly.
                openTab({ id: 'dashboard-overview', title: 'الرئيسية', url: 'pages/dashboard.html' });
            } else {
                renderTabs();
            }
            syncThemeIcon();
        })();

        /* ==== اختيار السنة الدراسية ==== */
        const yearSelectEl = document.getElementById('ddlSchoolYear');
        if (yearSelectEl) {
            const savedYear = localStorage.getItem('schoolYear');
            if (savedYear) {
                yearSelectEl.value = savedYear;
            }
            yearSelectEl.addEventListener('change', function () {
                localStorage.setItem('schoolYear', this.value);
                window.dispatchEvent(new CustomEvent('schoolYearChanged', { detail: this.value }));
            });
        }


    </script>













    <script>
        (function () {
            const framesRoot = document.getElementById('frames');
            const toggleBtn = document.getElementById('iframeFullscreenToggle');

            document.getElementById('exitFullscreenBtn')
                ?.addEventListener('click', exitFullscreen);

            // أنشئ شريط الخروج لو مش موجود
            function ensureFullscreenBar() {
                let bar = document.getElementById('fullscreenBar');
                if (!bar) {
                    bar = document.createElement('div');
                    bar.id = 'fullscreenBar';
                    bar.innerHTML = `
                <div class="bar-content">
                  <i class="bi bi-arrows-angle-contract"></i>
                  <span>وضع ملء الشاشة</span>
                  <button id="exitFullscreenBtn" class="close-cta">
                    <i class="bi bi-x-lg"></i> إنهاء ملء الشاشة
                  </button>
                </div>`;
                    document.body.appendChild(bar);
                }
                // كِلِك على الشريط أو الزر = خروج
                bar.addEventListener('click', exitFullscreen);
                bar.querySelector('#exitFullscreenBtn')?.addEventListener('click', function (e) {
                    e.stopPropagation(); exitFullscreen();
                });
                // زر ESC للخروج
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') exitFullscreen();
                });
                return bar;
            }

            // يجيب iframe النشط بشكل مرن (بدون الاعتماد على state)
            function getActiveIframe() {
                // 1) إذا عندك state.tabs شغّالة
                try {
                    const activeTab = window.state?.tabs?.find(t => t.active);
                    if (activeTab) {
                        const f = framesRoot?.querySelector(`iframe[data-tab="${activeTab.id}"]`);
                        if (f) return f;
                    }
                } catch { }
                // 2) أوّل iframe ظاهر
                const iframes = Array.from(document.querySelectorAll('#frames iframe'));
                const visible = iframes.find(f => getComputedStyle(f).display !== 'none');
                if (visible) return visible;
                // 3) آخر iframe مضاف
                return iframes[iframes.length - 1] || null;
            }

            function enterFullscreen() {
                const iframe = getActiveIframe();
                if (!iframe) return;

                iframe.classList.add('iframe-fullscreen');
                document.querySelector('.appbar')?.classList.add('fullscreen-hidden');
                document.querySelector('.sidebar')?.classList.add('fullscreen-hidden');
                document.querySelector('.ws-tabs')?.classList.add('fullscreen-hidden');
                document.getElementById('drawer')?.classList.add('fullscreen-hidden');

                ensureFullscreenBar().style.display = 'block';

                // بدّل أيقونة الزر (لو موجودة)
                const icon = toggleBtn?.querySelector('i');
                if (icon) { icon.classList.remove('bi-arrows-fullscreen'); icon.classList.add('bi-arrows-angle-contract'); }
            }

            function exitFullscreen() {
                const iframe = document.querySelector('#frames .iframe-fullscreen');
                if (!iframe) return;

                iframe.classList.remove('iframe-fullscreen');
                document.querySelector('.appbar')?.classList.remove('fullscreen-hidden');
                document.querySelector('.sidebar')?.classList.remove('fullscreen-hidden');
                document.querySelector('.ws-tabs')?.classList.remove('fullscreen-hidden');
                document.getElementById('drawer')?.classList.remove('fullscreen-hidden');

                const bar = document.getElementById('fullscreenBar');
                if (bar) bar.style.display = 'none';

                const icon = toggleBtn?.querySelector('i');
                if (icon) { icon.classList.add('bi-arrows-fullscreen'); icon.classList.remove('bi-arrows-angle-contract'); }
            }

            function toggleFullscreen() {
                const isOn = !!document.querySelector('#frames .iframe-fullscreen');
                if (isOn) exitFullscreen(); else enterFullscreen();
            }

            // اربط الزر
            toggleBtn?.addEventListener('click', function (e) {
                e.preventDefault(); e.stopPropagation(); toggleFullscreen();
            });

            // حضّر الشريط مرة واحدة
            ensureFullscreenBar();
        })();
    </script>
    <script>
        // تحديث السنة المختارة
        document.querySelectorAll('#yearDropdown + .dropdown-menu .dropdown-item')
            .forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const yearText = this.textContent;
                    const yearValue = this.dataset.value;
                    document.getElementById('currentYear').textContent = yearText;
                    localStorage.setItem('schoolYear', yearValue);
                    // أرسل حدث لتحديث باقي النظام
                    window.dispatchEvent(new CustomEvent('schoolYearChanged', { detail: yearValue }));
                });
            });

        // استرجاع السنة المحفوظة
        const savedYear = localStorage.getItem('schoolYear');
        if (savedYear) {
            const selectedItem = document.querySelector(`#yearDropdown + .dropdown-menu .dropdown-item[data-value="${savedYear}"]`);
            if (selectedItem) {
                document.getElementById('currentYear').textContent = selectedItem.textContent;
            }
        }
    </script>

</body>
</html>